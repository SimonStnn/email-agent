trigger:
  tags:
    include:
      - agent-ui-v*

pool: IaC

variables:
  group: 'resource-access'
  acrName: 'pocmcpcerm'
  rgName: 'POC-MCP'
  service: 'agent-ui'
  context: 'gradio-app'

steps:
  - checkout: self

  - bash: |
      echo "Checking if variables are set..."
      if [ -z "$CLIENT_ID" ]; then echo "CLIENT_ID is empty"; exit 1; fi
      if [ -z "$CLIENT_SECRET" ]; then echo "CLIENT_SECRET is empty"; exit 1; fi
      if [ -z "$TENANT_ID" ]; then echo "TENANT_ID is empty"; exit 1; fi
      if [ -z "$SUBSCRIPTION" ]; then echo "SUBSCRIPTION is empty"; exit 1; fi

      echo "All variables are set, proceeding with Azure login..."

      # Login to Azure
      az login --service-principal -u $(clientId) -p $(clientSecret) --tenant $(tenantId) || exit 1

      # Set subscription
      az account set --subscription $(subscription)

      # Create resource group if not exists
      az group create --name $(rgName) --location eastus --only-show-errors || echo "Resource group already exists"

      # Create ACR if not exists
      az acr create --name $(acrName) --resource-group $(rgName) --sku Basic --only-show-errors || echo "ACR already exists"
    displayName: 'Create Resource Group and ACR if not exists'

  - script: |
      # Parse tag to get version
      TAG_NAME=$(Build.SourceBranchName)
      if [[ $TAG_NAME =~ ^agent-ui-v(.+)$ ]]; then
        VERSION=${BASH_REMATCH[1]}
        echo "Version: $VERSION"
      else
        echo "Invalid tag format"
        exit 1
      fi

      # Build image
      docker build -t $(service):$VERSION $(context)

      # Login to ACR
      az acr login --name $(acrName)

      # Tag and push
      IMAGE_NAME=$(acrName).azurecr.io/$(service)

      docker tag $(service):$VERSION $IMAGE_NAME:latest
      docker tag $(service):$VERSION $IMAGE_NAME:$VERSION
      docker tag $(service):$VERSION $IMAGE_NAME:${VERSION%.*}  # x.x
      docker tag $(service):$VERSION $IMAGE_NAME:${VERSION%%.*}  # x

      docker push $IMAGE_NAME:latest
      docker push $IMAGE_NAME:$VERSION
      docker push $IMAGE_NAME:${VERSION%.*}
      docker push $IMAGE_NAME:${VERSION%%.*}
    displayName: 'Build and Push Image'
