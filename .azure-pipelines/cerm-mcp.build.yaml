trigger:
  tags:
    include:
      - cerm-mcp-v*

pool: IaC

variables:
  - group: 'resource-access'
  - name: acrName
    value: 'pocmcpservercerm'
  - name: rgName
    value: 'POC-MCP'
  - name: service
    value: 'cerm-mcp'
  - name: context
    value: 'mcp-server'
  - name: containerInstanceName
    value: 'cerm-mcp-aci'
  - name: containerPort
    value: '8000'

steps:
  - checkout: self

  - bash: |
      # Login to Azure
      az login --service-principal -u $(clientId) -p $(clientSecret) --tenant $(tenantId) || exit 1

      # Set subscription
      az account set --subscription $(subscription)

      # Create resource group if not exists
      az group create --name $(rgName) --location swedencentral --only-show-errors || echo "Resource group already exists"

      # Register Microsoft.ContainerRegistry provider
      echo "Registering Microsoft.ContainerRegistry provider..."
      az provider register --namespace Microsoft.ContainerRegistry --wait

      # Create ACR if not exists
      az acr create --name $(acrName) --resource-group $(rgName) --sku Basic --only-show-errors || echo "ACR already exists"
    displayName: 'Create Resource Group and ACR if not exists'

  - script: |
      # Parse tag to get version
      TAG_NAME=$(Build.SourceBranchName)
      echo "Tag Name: $TAG_NAME"
      if [[ $TAG_NAME =~ ^cerm-mcp-v(.+)$ ]]; then
        VERSION=${BASH_REMATCH[1]}
        echo "Version: $VERSION"
      else
        echo "Invalid tag format"
        exit 1
      fi

      # Build image
      echo "Building image: $(service):$VERSION"
      docker build -t $(service):$VERSION $(context) || {
        echo "ERROR: Docker build failed"
        exit 1
      }

      # Verify image was built
      docker images $(service):$VERSION

      # Login to ACR
      echo "Logging into ACR: $(acrName)"
      az acr login --name $(acrName) || {
        echo "ERROR: ACR login failed"
        exit 1
      }

      # Tag and push to poc-mcp repository
      ACR_LOGIN_SERVER=$(acrName).azurecr.io
      IMAGE_NAME=$ACR_LOGIN_SERVER/poc-mcp/$(service)

      echo "Tagging and pushing to: $IMAGE_NAME"

      docker tag $(service):$VERSION $IMAGE_NAME:latest
      docker tag $(service):$VERSION $IMAGE_NAME:$VERSION
      docker tag $(service):$VERSION $IMAGE_NAME:${VERSION%.*}  # x.x
      docker tag $(service):$VERSION $IMAGE_NAME:${VERSION%%.*}  # x

      echo "Pushing images..."
      docker push $IMAGE_NAME:latest || { echo "ERROR: Push failed for latest"; exit 1; }
      docker push $IMAGE_NAME:$VERSION || { echo "ERROR: Push failed for $VERSION"; exit 1; }
      docker push $IMAGE_NAME:${VERSION%.*} || { echo "ERROR: Push failed for ${VERSION%.*}"; exit 1; }
      docker push $IMAGE_NAME:${VERSION%%.*} || { echo "ERROR: Push failed for ${VERSION%%.*}"; exit 1; }

      echo "Successfully pushed all tags to ACR"
    displayName: 'Build and Push Image'

  - bash: |
      set -e  # Exit on any error

      # Parse tag to get version
      TAG_NAME=$(Build.SourceBranchName)
      if [[ $TAG_NAME =~ ^cerm-mcp-v(.+)$ ]]; then
        VERSION=${BASH_REMATCH[1]}
      else
        echo "Invalid tag format"
        exit 1
      fi

      # Grant AcrPull role to the service principal
      echo "Granting AcrPull role to service principal..."
      ACR_ID=$(az acr show --name $(acrName) --query id -o tsv)
      az role assignment create \
        --assignee $(clientId) \
        --role AcrPull \
        --scope $ACR_ID || echo "Role assignment may already exist"

      # Enable admin user on ACR as fallback
      echo "Enabling ACR admin user..."
      az acr update --name $(acrName) --admin-enabled true

      # Wait a moment for the admin user to be fully enabled
      sleep 5

      # Get ACR credentials
      echo "Getting ACR credentials..."
      ACR_USERNAME=$(az acr credential show --name $(acrName) --query username -o tsv)
      ACR_PASSWORD=$(az acr credential show --name $(acrName) --query passwords[0].value -o tsv)

      # Verify credentials were retrieved
      if [ -z "$ACR_USERNAME" ] || [ -z "$ACR_PASSWORD" ]; then
        echo "Failed to retrieve ACR credentials"
        exit 1
      fi

      echo "ACR Username: $ACR_USERNAME"
      echo "Password length: ${#ACR_PASSWORD}"

      # Verify the image exists in ACR
      echo "Verifying image exists in ACR..."
      ACR_LOGIN_SERVER=$(acrName).azurecr.io
      IMAGE_REPO=poc-mcp/$(service)

      # List images to verify
      az acr repository show --name $(acrName) --repository $IMAGE_REPO || {
        echo "ERROR: Image repository $IMAGE_REPO not found in ACR"
        echo "Available repositories:"
        az acr repository list --name $(acrName) -o table
        exit 1
      }

      # List tags to verify latest exists
      echo "Available tags for $IMAGE_REPO:"
      az acr repository show-tags --name $(acrName) --repository $IMAGE_REPO -o table

      # Register Microsoft.ContainerInstance provider
      echo "Registering Microsoft.ContainerInstance provider..."
      az provider register --namespace Microsoft.ContainerInstance --wait

      # Deploy to Azure Container Instances
      ACR_LOGIN_SERVER=$(acrName).azurecr.io
      IMAGE_NAME=$ACR_LOGIN_SERVER/poc-mcp/$(service):latest

      echo "Image: $IMAGE_NAME"

      echo "Deploying container instance: $(containerInstanceName)"

      # Check if container exists and delete if it does
      if az container show --resource-group $(rgName) --name $(containerInstanceName) &>/dev/null; then
        echo "Container already exists, deleting..."
        az container delete \
          --resource-group $(rgName) \
          --name $(containerInstanceName) \
          --yes

        # Wait for deletion to complete
        echo "Waiting for deletion to complete..."
        sleep 10
      fi

      # Create container
      echo "Creating container with ACR credentials..."
      echo "Registry: $ACR_LOGIN_SERVER"
      echo "Image: $IMAGE_NAME"
      echo "Username: $ACR_USERNAME"

      # Write password to file to avoid shell escaping issues
      echo -n "$ACR_PASSWORD" > /tmp/acr_password.txt

      az container create \
        --resource-group $(rgName) \
        --name $(containerInstanceName) \
        --image $IMAGE_NAME \
        --os-type Linux \
        --ip-address Public \
        --registry-login-server $ACR_LOGIN_SERVER \
        --registry-username "$ACR_USERNAME" \
        --registry-password "$(cat /tmp/acr_password.txt)" \
        --dns-name-label $(containerInstanceName) \
        --ports $(containerPort) \
        --cpu 1 \
        --memory 2 \
        --restart-policy Always \
        --location swedencentral \
        --verbose

      # Clean up password file
      rm -f /tmp/acr_password.txt

      # Get the FQDN
      FQDN=$(az container show \
        --resource-group $(rgName) \
        --name $(containerInstanceName) \
        --query ipAddress.fqdn -o tsv)

      echo "##############################################"
      echo "Deployment completed successfully!"
      echo "Service URL: http://$FQDN:$(containerPort)"
      echo "##############################################"
    displayName: 'Deploy to Azure Container Instances'
