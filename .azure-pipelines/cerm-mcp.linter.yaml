trigger:
  branches:
    include:
      - main
  paths:
    include:
      - mcp-server/**

pool: IaC

variables:
  projectDir: 'mcp-server'
  PRE_COMMIT_HOME: $(Pipeline.Workspace)/.cache/pre-commit

steps:
  - checkout: self
    persistCredentials: true

  - script: |
      pwd
      ls -la
    displayName: Debug

  - script: |
      echo "Setting up environment with uv..."
      curl -LsSf https://astral.sh/uv/install.sh | sh
      uv --version

      echo "Installing Python version from .python-version..."
      uv python install $(cat .python-version)

      echo "Syncing dependencies..."
      uv sync --all-extras --dev
    workingDirectory: $(projectDir)
    displayName: Setup Environment

  - script: |
      uv run ruff check . && uv run ruff format --check --diff .
    workingDirectory: $(projectDir)
    displayName: Run Ruff

  - script: |
      uv run mypy src/
    workingDirectory: $(projectDir)
    displayName: Run MyPy

  - script: |
      uv run isort --check-only .
    workingDirectory: $(projectDir)
    displayName: Run Isort

  - script: |
      # Read version from pyproject.toml
      VERSION=$(grep '^version =' pyproject.toml | sed 's/version = "\(.*\)"/\1/')

      echo "Version: cerm-mcp=$VERSION"

      # Configure git
      cd ..
      export HOME=/tmp
      git config --global user.email "azure-pipelines@azure.com"
      git config --global user.name "Azure Pipelines"

      # Create and push tag
      git tag "cerm-mcp-v$VERSION"
      git push --tags
    workingDirectory: $(projectDir)
    displayName: Push Version Tag
